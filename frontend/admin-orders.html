<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pedidos - Admin PedeAi</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="css/styles.css" />
    <script src="js/auth-guard.js"></script>

    <style>
      /* Estilos Espec√≠ficos do Timer */
      .timer-badge {
        display: inline-flex;
        align-items: center;
        gap: 5px;
        padding: 4px 10px;
        border-radius: 4px;
        font-size: 0.85rem;
        font-weight: 700;
        color: white;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
      }
      .timer-novo {
        background: #007bff;
      }
      .timer-preparo {
        background: #ffc107;
        color: #333;
      }
      .timer-entrega {
        background: #17a2b8;
      }
      .urgent {
        animation: pulse-red 2s infinite;
        background: #dc3545 !important;
        color: white !important;
      }
      @keyframes pulse-red {
        0% {
          opacity: 1;
        }
        50% {
          opacity: 0.7;
        }
        100% {
          opacity: 1;
        }
      }
      .total-time {
        font-size: 0.75rem;
        color: #666;
        font-weight: 500;
      }
    </style>
  </head>
  <body>
    <div class="admin-wrapper">
      <aside class="admin-sidebar">
        <div class="sidebar-logo">
          PedeAi<span style="color: var(--color-primary)">.</span>
        </div>
        <nav class="sidebar-menu">
          <a href="admin.html" class="sidebar-link"
            ><span>üè¢</span> Restaurantes</a
          >
          <a href="admin-products.html" class="sidebar-link"
            ><span>üçî</span> Produtos</a
          >
          <a href="admin-orders.html" class="sidebar-link active"
            ><span>üîî</span> Pedidos</a
          >
          <a href="admin-finance.html" class="sidebar-link"
            ><span>üí∞</span> Financeiro</a
          >
          <a href="admin-store.html" class="sidebar-link"
            ><span>‚öôÔ∏è</span> Minha Loja</a
          >
          <div style="margin-top: auto">
            <a
              href="index.html"
              class="sidebar-link"
              target="_blank"
              style="margin-bottom: 5px"
              ><span>üîó</span> Ver Loja</a
            >
            <a
              href="#"
              onclick="logout()"
              class="sidebar-link"
              style="color: var(--color-danger)"
              ><span>üö™</span> Sair</a
            >
          </div>
        </nav>
      </aside>

      <main class="admin-content">
        <header class="page-header">
          <div>
            <h1 class="page-title">Cozinha em Tempo Real</h1>
            <p style="color: #666">Monitore o tempo de cada etapa.</p>
          </div>

          <div
            style="
              background: white;
              padding: 5px 10px;
              border-radius: 8px;
              border: 1px solid #ddd;
            "
          >
            <select
              id="restaurant-select"
              style="
                border: none;
                outline: none;
                font-size: 1rem;
                padding: 5px;
                min-width: 200px;
              "
            >
              <option value="">Carregando...</option>
            </select>
          </div>
        </header>

        <div id="orders-container" class="kanban-board">
          <div
            style="
              grid-column: 1/-1;
              text-align: center;
              padding: 50px;
              color: #999;
            "
          >
            Aguardando sele√ß√£o...
          </div>
        </div>
      </main>
    </div>

<script>
        const API = "https://pede-ai.onrender.com/api";
        const select = document.getElementById("restaurant-select"); 
        const container = document.getElementById("orders-container");

        // Som de Notifica√ß√£o
        const audioAlert = new Audio("https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3");

        let ordersData = [];
        let currentUser = null;
        let lastOrderCount = 0;
        let firstLoad = true;

        const STORAGE_KEY = 'pedeai_admin_selected_store';

        // 1. INICIALIZA√á√ÉO
        async function init() {
            const token = localStorage.getItem("pedeai_token");
            if (!token) return window.location.href = 'login.html';

            try {
                const res = await fetch(`${API}/auth/me`, { headers: { Authorization: `Bearer ${token}` } });
                const json = await res.json();
                
                if (json.success) {
                    currentUser = json.data;
                    setupUI();
                }
            } catch (e) { console.error("Erro Auth:", e); }
        }

        function setupUI() {
            if (currentUser.role === "admin") {
                if(select) loadAllRestaurants();
                else startPolling();
            } else {
                if(select) {
                    select.innerHTML = `<option value="${currentUser._id}">${currentUser.name}</option>`;
                    select.value = currentUser._id;
                    select.disabled = true;
                }
                startPolling();
            }
        }

        async function loadAllRestaurants() {
            const token = localStorage.getItem("pedeai_token");
            try {
                const res = await fetch(`${API}/restaurants`, { headers: { Authorization: `Bearer ${token}` } });
                const json = await res.json();
                
                if(select && json.success) {
                    select.innerHTML = '<option value="">Todas as Lojas</option>';
                    
                    json.data.forEach(r => {
                        const opt = document.createElement("option");
                        opt.value = r._id;
                        opt.textContent = r.name;
                        select.appendChild(opt);
                    });

                    const savedStore = localStorage.getItem(STORAGE_KEY);
                    if(savedStore && Array.from(select.options).some(o => o.value === savedStore)) {
                        select.value = savedStore;
                    }

                    select.addEventListener("change", () => {
                        localStorage.setItem(STORAGE_KEY, select.value);
                        fetchOrders();
                    });
                }
                startPolling();
            } catch(e) { console.error("Erro Restaurants:", e); }
        }

        function startPolling() {
            fetchOrders();
            setInterval(fetchOrders, 10000); 
        }

        async function fetchOrders() {
            const token = localStorage.getItem("pedeai_token");
            let url = `${API}/orders`;
            
            if (select && select.value) {
                url = `${API}/orders/restaurant/${select.value}`;
            } else if (currentUser.role === 'restaurant') {
                url = `${API}/orders/restaurant/${currentUser._id}`;
            }

            try {
                const res = await fetch(url, { headers: { Authorization: `Bearer ${token}` } });
                if(!res.ok) { console.warn(`Erro API: ${res.status}`); return; }

                const json = await res.json();

                if (json.success) {
                    ordersData = json.data;
                    ordersData.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                    checkNewOrders(); 
                    renderOrders();   
                }
            } catch (e) { console.error("Erro Fetch:", e); }
        }

        function checkNewOrders() {
            const newOrdersCount = ordersData.filter(o => o.status === "Novo").length;
            if (newOrdersCount > lastOrderCount && !firstLoad) {
                try { audioAlert.play(); } catch (e) {}
            }
            lastOrderCount = newOrdersCount;
            firstLoad = false;
        }

        function renderOrders() {
            container.className = 'orders-grid';
            container.innerHTML = "";

            // --- DEBUG: Veja isso no Console do Navegador (F12) ---
            console.log("Renderizando pedidos. Usu√°rio Atual:", currentUser);
            // -----------------------------------------------------

            // Bot√£o Apagar Tudo (Aparece se for Admin)
            if(currentUser && currentUser.role === 'admin') {
                const dangerZone = document.createElement('div');
                dangerZone.style.gridColumn = '1 / -1';
                dangerZone.style.textAlign = 'right';
                dangerZone.style.marginBottom = '20px';
                dangerZone.innerHTML = `
                    <button onclick="deleteAllOrders()" style="background:#fee2e2; color:#991b1b; border:1px solid #ef4444; padding:8px 15px; border-radius:8px; font-size:0.8rem; cursor:pointer; font-weight:bold;">
                        üóëÔ∏è LIMPAR BANCO DE DADOS (ADMIN)
                    </button>
                `;
                container.appendChild(dangerZone);
            }

            if (ordersData.length === 0) {
                container.innerHTML += '<div style="color:#999; grid-column:1/-1; text-align:center; padding:40px">Nenhum pedido encontrado.</div>';
                return;
            }

            ordersData.forEach(order => {
                // C√°lculos de tempo...
                const now = new Date();
                let stageStart = new Date(order.createdAt);
                if (order.timeline && order.timeline.length > 0) stageStart = new Date(order.timeline[order.timeline.length - 1].timestamp);
                const stageDiff = Math.floor((now - stageStart) / 60000);

                let cfg = { label: '?', class: '', btnHtml: '' };

                // Configura√ß√µes de status (Novo, Em Preparo, etc)...
                if (order.status === "Novo") {
                    cfg.label = `‚è≥ ${stageDiff} min na fila`; cfg.class = "status-new";
                    cfg.btnHtml = `<div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;"><button onclick="acceptOrder('${order._id}', '${order.customer.phone}', '${order.customer.name}')" class="btn-action btn-accept">Aceitar üî•</button><button onclick="rejectOrder('${order._id}', '${order.customer.phone}', '${order.customer.name}')" class="btn-action btn-reject">Rejeitar ‚úï</button></div>`;
                } else if (order.status === "Em Preparo") {
                    cfg.label = `üç≥ ${stageDiff} min cozinhando`; cfg.class = "status-prep";
                    cfg.btnHtml = `<button onclick="updateStatus('${order._id}', 'Saiu para Entrega')" class="btn-action btn-advance" style="background:#f59e0b; margin-top:10px;">Enviar Entrega üõµ</button>`;
                } else if (order.status === "Saiu para Entrega") {
                    cfg.label = `üõµ ${stageDiff} min na rua`; cfg.class = "status-deliv";
                    cfg.btnHtml = `<button onclick="updateStatus('${order._id}', 'Entregue')" class="btn-action btn-advance" style="background:#8b5cf6; margin-top:10px;">Concluir ‚úÖ</button>`;
                } else if (order.status === "Cancelado") {
                     cfg.label = "Cancelado"; cfg.class = "status-done";
                     cfg.btnHtml = `<div style="text-align:center; color:#ef4444; font-weight:bold; margin-top:10px;">Pedido Cancelado üö´</div>`;
                } else {
                    cfg.label = "Finalizado"; cfg.class = "status-done";
                    cfg.btnHtml = `<div style="text-align:center; color:gray; font-size:0.8rem; margin-top:10px;">Finalizado ‚úÖ</div>`;
                }

                // L√ìGICA DO BOT√ÉO DE DELETAR INDIVIDUAL
                // Verifica explicitamente se √© admin OU se queremos deixar vis√≠vel para debug
                let deleteBtnHtml = '';
                if (currentUser && currentUser.role === 'admin') {
                    deleteBtnHtml = `
                        <button onclick="deleteOrder('${order._id}')" title="Apagar Pedido (Admin)" style="
                            background: none; border: none; cursor: pointer; font-size: 1.1rem; 
                            margin-left: auto; color: #ef4444; padding: 5px;">
                            üóëÔ∏è
                        </button>
                    `;
                }

                // Nome do Restaurante (seguran√ßa para n√£o dar erro)
                const restaurantName = order.restaurant ? order.restaurant.name : 'Loja Desconhecida';

                const html = `
                    <div class="order-ticket">
                        <div class="ticket-header" style="display:flex; align-items:center; justify-content:space-between;">
                            <div style="display:flex; align-items:center; gap:5px;">
                                <span class="ticket-id">#${order._id.slice(-4).toUpperCase()}</span>
                            </div>
                            <div style="display:flex; align-items:center; gap:10px;">
                                <span class="ticket-timer ${cfg.class}">${cfg.label}</span>
                                ${deleteBtnHtml} </div>
                        </div>

                        <div class="ticket-body">
                            <div style="font-size:1rem; font-weight:800; color:#0f172a; margin-bottom:10px; padding-bottom:5px; border-bottom:1px solid #f1f5f9;">
                                üè™ ${restaurantName}
                            </div>

                            <div class="customer-info">
                                <span class="customer-name">${order.customer.name}</span>
                                <div style="font-size:0.85rem;">üìç ${order.customer.address}</div>
                            </div>
                            <div class="order-items">
                                ${order.items.map(item => `
                                    <div class="item-row">
                                        <span><b>${item.quantity}x</b> ${item.name}</span>
                                    </div>
                                    ${item.observation ? `<span class="item-obs">‚ö†Ô∏è ${item.observation}</span>` : ''}
                                `).join('')}
                            </div>
                            
                            <div style="margin-top:10px; font-size:0.8rem; color:${order.paymentStatus === 'Pago' ? 'green' : (order.paymentStatus === 'Reembolsado' ? 'orange' : '#666')}">
                                üí≥ ${order.paymentMethod} ‚Ä¢ <b>${order.paymentStatus || 'Pendente'}</b>
                            </div>
                        </div>

                        <div class="ticket-footer">
                            <div class="ticket-total">
                                <span>Total:</span>
                                <span>R$ ${order.total.toFixed(2)}</span>
                            </div>
                            ${cfg.btnHtml}
                        </div>
                    </div>
                `;
                container.innerHTML += html;
            });
        }
        async function deleteOrder(id) {
            if(!confirm("TEM CERTEZA? Isso apagar√° o pedido permanentemente e n√£o gerar√° reembolso.")) return;
            
            const token = localStorage.getItem("pedeai_token");
            try {
                const res = await fetch(`${API}/orders/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if(res.ok) {
                    // Remove visualmente ou recarrega
                    ordersData = ordersData.filter(o => o._id !== id);
                    renderOrders();
                } else {
                    alert("Erro ao deletar");
                }
            } catch(e) { console.error(e); }
        }

        async function deleteAllOrders() {
            const code = prompt("DIGITE 'DELETAR' PARA APAGAR TODOS OS PEDIDOS DO SISTEMA:");
            if(code !== 'DELETAR') return;

            const token = localStorage.getItem("pedeai_token");
            try {
                const res = await fetch(`${API}/orders`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const json = await res.json();
                if(json.success) {
                    alert("Banco de dados limpo!");
                    fetchOrders();
                } else {
                    alert("Erro: " + json.error);
                }
            } catch(e) { console.error(e); }
        }

        async function updateStatus(id, status) {
            const token = localStorage.getItem("pedeai_token");
            try {
                await fetch(`${API}/orders/${id}`, {
                    method: "PATCH",
                    headers: { "Content-Type": "application/json", Authorization: `Bearer ${token}` },
                    body: JSON.stringify({ status }),
                });
                fetchOrders();
            } catch (e) { console.error(e); }
        }

        async function acceptOrder(id, phone, name) {
            if (!confirm("Aceitar pedido e enviar WhatsApp?")) return;
            await updateStatus(id, "Em Preparo");
            
            const path = window.location.pathname.substring(0, window.location.pathname.lastIndexOf("/"));
            const trackingLink = `${window.location.origin}${path}/rastreio.html?id=${id}`;
            const msg = `Ol√° *${name}*! üëã\n\nSeu pedido foi *ACEITO* e j√° est√° sendo preparado üî•\n\nüÜî Pedido: *${id.slice(-6).toUpperCase()}*\n\nüì¶ *Acompanhe em tempo real:*\n${trackingLink}`;
            
            window.open(`https://api.whatsapp.com/send?phone=${phone.replace(/\D/g, "")}&text=${encodeURIComponent(msg)}`, "_blank");
        }

        async function rejectOrder(id, phone, name) {
            const reason = prompt("Motivo (Opcional):", "Alta demanda");
            if (reason === null) return;
            await updateStatus(id, "Cancelado");
            
            if (confirm("Avisar no WhatsApp?")) {
                const msg = `Ol√° *${name}*.\n\nInfelizmente n√£o poderemos atender seu pedido agora.\n\nMotivo: ${reason}\n\nPedimos desculpas! üôè`;
                window.open(`https://api.whatsapp.com/send?phone=${phone.replace(/\D/g, "")}&text=${encodeURIComponent(msg)}`, "_blank");
            }
        }

        function logout() {
            localStorage.removeItem('pedeai_token');
            window.location.href = 'login.html';
        }

        init();
    </script>
  </body>
</html>
