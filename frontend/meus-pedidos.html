<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meus Pedidos - PedeAi</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css">
    <style>
        .order-history-card {
            background: white; border: 1px solid var(--border);
            border-radius: 12px; padding: 20px; margin-bottom: 15px;
            display: flex; justify-content: space-between; align-items: center;
            transition: 0.2s;
        }
        .order-history-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-sm); }
        .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: bold; }
        
        .st-novo { background: #dbeafe; color: #1e40af; }
        .st-pgto { background: #fef3c7; color: #b45309; } /* Aguardando Pagamento */
        .st-ok { background: #dcfce7; color: #166534; }
        .st-cancel { background: #fee2e2; color: #991b1b; }
    </style>
</head>
<body>

    <header class="main-header" style="position: sticky; top: 0; margin-bottom: 20px;">
        <nav class="glass-nav" style="justify-content: space-between;">
            <a href="index.html" class="logo">PedeAi<span style="color:var(--primary)">.</span></a>
            <a href="index.html" class="btn" style="background: #f1f5f9; color: #333;">‚Üê Voltar</a>
        </nav>
    </header>

    <div class="container" style="max-width: 600px; padding-top: 20px;">
        <div style="text-align: center; margin-bottom: 30px;">
            <h1 style="font-weight: 800;">Meus Pedidos üßæ</h1>
            <p style="color: #666;">Digite seu celular para recuperar seu hist√≥rico e c√≥digos Pix.</p>
        </div>

        <div style="display: flex; gap: 10px; margin-bottom: 30px;">
            <input type="tel" id="phone-input" class="form-input" placeholder="Seu WhatsApp (Ex: 47999999999)">
            <button onclick="searchOrders()" class="btn-primary">Buscar</button>
        </div>

        <div id="history-list">
            <div style="text-align: center; color: #999; margin-top: 40px;">
                Digite seu n√∫mero acima para ver seus pedidos.
            </div>
        </div>
    </div>

    <div id="pix-modal" class="modal-overlay">
        <div class="modal-content" style="text-align: center; max-width: 400px;">
            <h3>Pagar com Pix</h3>
            <p style="font-size: 0.9rem; color: #666;">Escaneie para liberar seu pedido.</p>
            <img id="pix-qr-img" src="" style="width: 200px; height: 200px; margin: 0 auto; display: block;">
            <input type="text" id="pix-code-text" readonly style="width: 100%; margin: 10px 0; padding:10px; text-align:center; background:#f8fafc; border:1px solid #ddd; border-radius:6px;">
            <button onclick="copyPix()" style="color:var(--primary); background:none; border:none; font-weight:bold; cursor:pointer;">Copiar C√≥digo</button>
            <div style="margin-top: 20px;">
                <button onclick="document.getElementById('pix-modal').style.display='none'" class="btn" style="width:100%; justify-content:center;">Fechar</button>
            </div>
        </div>
    </div>

    <script>
        const API = 'https://pede-ai.onrender.com/api';

        async function searchOrders() {
            const phone = document.getElementById('phone-input').value.replace(/\D/g, '');
            if(phone.length < 8) return alert("Digite um n√∫mero v√°lido");
            
            const list = document.getElementById('history-list');
            list.innerHTML = '<p style="text-align:center;">Buscando...</p>';

            try {
                const res = await fetch(`${API}/orders/customer/${phone}`);
                const json = await res.json();
                
                if(!json.success || json.data.length === 0) {
                    list.innerHTML = '<p style="text-align:center;">Nenhum pedido encontrado para este n√∫mero.</p>';
                    return;
                }

                list.innerHTML = json.data.map(order => {
                    const date = new Date(order.createdAt).toLocaleDateString('pt-BR');
                    const total = order.total.toFixed(2);
                    let statusClass = 'st-ok';
                    let actionBtn = `<a href="rastreio.html?id=${order._id}" class="btn" style="font-size:0.8rem; padding:5px 10px;">Rastrear</a>`;

                    if(order.status === 'Novo') statusClass = 'st-novo';
                    if(order.status === 'Cancelado') statusClass = 'st-cancel';
                    
                    // L√ìGICA DO PIX PENDENTE
                    if(order.status === 'Aguardando Pagamento' || (order.paymentMethod === 'Pix' && order.paymentStatus !== 'Pago' && order.status !== 'Cancelado')) {
                        statusClass = 'st-pgto';
                        // Bot√£o para pagar
                        actionBtn = `<button onclick="recoverPix('${order.total}', '${order._id}')" class="btn-primary" style="font-size:0.8rem; padding:5px 10px; background:#f59e0b;">Pagar Pix üí∏</button>`;
                    }

                    return `
                        <div class="order-history-card">
                            <div>
                                <div style="font-weight:bold; font-size:1.1rem;">${order.restaurant ? order.restaurant.name : 'Restaurante'}</div>
                                <div style="font-size:0.85rem; color:#666;">${date} ‚Ä¢ R$ ${total}</div>
                                <span class="status-badge ${statusClass}" style="margin-top:5px; display:inline-block;">${order.status}</span>
                            </div>
                            <div>${actionBtn}</div>
                        </div>
                    `;
                }).join('');

            } catch(e) { console.error(e); list.innerHTML = 'Erro ao buscar.'; }
        }

        async function recoverPix(amount, orderId) {
            // Gera um novo QR Code para o mesmo pedido
            // (Na pr√°tica, o ideal seria recuperar o existente, mas gerar um novo funciona igual para o cliente pagar)
            try {
                const res = await fetch(`${API}/payments/pix`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        amount: amount,
                        description: `Pgto Pedido #${orderId.slice(-4)}`,
                        payer: { email: 'recuperacao@email.com' } // Email dummy
                    })
                });
                const json = await res.json();
                if(json.success) {
                    const data = json.data;
                    document.getElementById('pix-qr-img').src = `data:image/png;base64,${data.qr_code_base64}`;
                    document.getElementById('pix-code-text').value = data.qr_code;
                    document.getElementById('pix-modal').style.display = 'flex';
                }
            } catch(e) { alert("Erro ao gerar Pix"); }
        }

        function copyPix() {
            const copyText = document.getElementById("pix-code-text");
            copyText.select();
            document.execCommand("copy");
            alert("C√≥digo copiado!");
        }

        async function checkPayment(isAuto = false, orderId) {
            if(!currentPaymentId) return;
            const msgDiv = document.getElementById('pix-status-msg');
            if(!isAuto) msgDiv.innerText = "Verificando manualmente...";

            try {
                const res = await fetch(`${API}/payments/status/${currentPaymentId}`);
                const json = await res.json();
                
                if (json.status === 'approved') {
                    // 1. AVISAR O USU√ÅRIO
                    clearInterval(paymentCheckInterval);
                    msgDiv.style.color = 'green';
                    msgDiv.innerText = "Pagamento Aprovado! ‚úÖ";

                    // 2. SALVAR O ID DO PIX NO PEDIDO (CRUCIAL PARA REEMBOLSO!)
                    // Chama a nova rota que criamos
                    await fetch(`${API}/orders/${orderId}/pay`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            paymentId: currentPaymentId,
                            status: 'Novo'
                        })
                    });

                    // 3. REDIRECIONAR
                    setTimeout(() => {
                        closePixModal();
                        window.location.href = `rastreio.html?id=${orderId}`;
                    }, 1500);

                } else {
                    if(!isAuto) {
                        msgDiv.style.color = '#f59e0b';
                        msgDiv.innerText = "Ainda n√£o compensou. Aguarde...";
                    }
                }
            } catch(e) { console.error(e); }
        }
    </script>
</body>
</html>