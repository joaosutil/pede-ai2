<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Produtos - Admin PedeAi</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css">
    <script src="js/auth-guard.js"></script>
</head>
<body>
    <div class="admin-wrapper">
        
        <aside class="admin-sidebar">
            <div class="sidebar-logo">PedeAi<span style="color:var(--color-primary)">.</span></div>
            <nav class="sidebar-menu">
                <a href="admin.html" class="sidebar-link"><span>üè¢</span> Restaurantes</a>
                <a href="admin-products.html" class="sidebar-link active"><span>üçî</span> Produtos</a>
                <a href="admin-orders.html" class="sidebar-link"><span>üîî</span> Pedidos</a>
                <a href="admin-finance.html" class="sidebar-link"><span>üí∞</span> Financeiro</a>
                <a href="admin-store.html" class="sidebar-link"><span>‚öôÔ∏è</span> Minha Loja</a>
                <div style="margin-top: auto;">
                    <a href="index.html" class="sidebar-link" target="_blank" style="margin-bottom: 5px;"><span>üîó</span> Ver Loja</a>
                    <a href="#" onclick="logout()" class="sidebar-link" style="color: var(--color-danger);"><span>üö™</span> Sair</a>
                </div>
            </nav>
        </aside>

        <main class="admin-content">
            <header class="page-header">
                <h1 class="page-title">Adicionar Produto</h1>
            </header>

            <div class="admin-card">
                <form id="product-form" enctype="multipart/form-data">
                    
                    <div class="form-group" id="rest-select-group" style="background:#f9fafb; padding:15px; border-radius:8px; border:1px solid #eee;">
                        <label class="form-label">Restaurante</label>
                        <select name="restaurant" id="restaurant-select" class="form-select">
                            <option value="">Carregando...</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Nome do Produto</label>
                        <input type="text" name="name" class="form-input" required placeholder="Ex: X-Bacon Artesanal">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Descri√ß√£o</label>
                        <textarea name="description" class="form-input" style="height: 80px;" placeholder="P√£o brioche, burger 180g, queijo cheddar..."></textarea>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div class="form-group">
                            <label class="form-label">Pre√ßo (R$)</label>
                            <input type="number" step="0.01" name="price" class="form-input" required placeholder="0.00">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Categoria</label>
                            <select name="category" class="form-select">
                                <option value="Lanches">Lanches</option>
                                <option value="Bebidas">Bebidas</option>
                                <option value="Sobremesas">Sobremesas</option>
                                <option value="Por√ß√µes">Por√ß√µes</option>
                                <option value="Combos">Combos</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group" style="background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px dashed #ccc;">
                        <label class="form-label">Imagem do Produto</label>
                        
                        <div style="display: flex; gap: 20px; margin-bottom: 15px;">
                            <label style="cursor:pointer; display:flex; align-items:center; gap:5px;">
                                <input type="radio" name="imgType" value="link" checked onchange="toggleImageInput()"> 
                                üîó Link da Internet
                            </label>
                            <label style="cursor:pointer; display:flex; align-items:center; gap:5px;">
                                <input type="radio" name="imgType" value="file" onchange="toggleImageInput()"> 
                                üìÇ Enviar Arquivo
                            </label>
                        </div>

                        <div id="container-link">
                            <input type="url" name="image" id="input-link" class="form-input" placeholder="https://exemplo.com/foto.jpg" value="https://images.unsplash.com/photo-1568901346375-23c9450c58cd?w=500">
                        </div>

                      <div id="container-file" style="display: none; margin-top: 15px;">

    <input type="file" name="imageFile" id="input-file" class="file-input-hidden" accept="image/*">
    <label for="input-file" class="file-upload-label">
        <div class="upload-icon">üìÅ</div>
        <div>Clique para selecionar uma imagem</div>
        <small>(JPG, PNG, WEBP - Max 5MB)</small>
    </label>

    <div id="preview-container" class="image-preview-container">
        <img id="image-preview" class="image-preview" src="" alt="Preview">
        <button type="button" class="preview-remove-btn" onclick="clearFileInput()">√ó</button>
    </div>

</div>
                    </div>

                    <button type="submit" class="btn-submit">Salvar Produto</button>
                </form>
            </div>
        </main>
    </div>

    <script>
        const API = 'http://localhost:3000/api';
        const select = document.getElementById('restaurant-select');
        let currentUser = null;

        // --- 1. Inicializa√ß√£o e Permiss√µes ---
        (async () => {
            const token = localStorage.getItem('pedeai_token');
            if(!token) return; // Auth Guard j√° deve ter cuidado disso, mas garantimos.

            try {
                // Descobre quem √© o usu√°rio logado
                const res = await fetch(`${API}/auth/me`, { 
                    headers: { 'Authorization': `Bearer ${token}` } 
                });
                const json = await res.json();
                
                if(json.success) {
                    currentUser = json.data;
                    
                    if (currentUser.role === 'admin') {
                        // Se for Admin: Carrega lista de restaurantes para escolher
                        loadRestaurants(token);
                    } else {
                        // Se for Restaurante: Trava no ID dele e esconde o select visualmente
                        select.innerHTML = `<option value="${currentUser._id}">${currentUser.name}</option>`;
                        select.value = currentUser._id;
                        document.getElementById('rest-select-group').style.display = 'none';
                    }
                }
            } catch (error) {
                console.error("Erro de auth:", error);
            }
        })();

        // Carrega restaurantes (Apenas para Admin)
        async function loadRestaurants(token) {
            const res = await fetch(`${API}/restaurants`, { 
                headers: { 'Authorization': `Bearer ${token}` } 
            });
            const json = await res.json();
            
            select.innerHTML = '<option value="">Selecione o Restaurante...</option>';
            json.data.forEach(r => {
                const opt = document.createElement('option');
                opt.value = r._id;
                opt.textContent = r.name;
                select.appendChild(opt);
            });
        }

        // --- 2. L√≥gica Visual (Alternar Link/Arquivo) ---
        function toggleImageInput() {
            const type = document.querySelector('input[name="imgType"]:checked').value;
            const containerLink = document.getElementById('container-link');
            const containerFile = document.getElementById('container-file');
            const inputFile = document.getElementById('input-file');
            const inputLink = document.getElementById('input-link');

            if (type === 'link') {
                containerLink.style.display = 'block';
                containerFile.style.display = 'none';
                inputFile.value = ''; // Limpa sele√ß√£o de arquivo
            } else {
                containerLink.style.display = 'none';
                containerFile.style.display = 'block';
                inputLink.value = ''; // Limpa link de texto
            }
        }

        // --- 3. Envio do Formul√°rio (FormData) ---
        document.getElementById('product-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Cria o objeto FormData (Necess√°rio para envio de arquivos)
            const formData = new FormData(e.target);

            // Se for dono de restaurante, o select pode estar escondido ou disabled.
            // Garantimos que o ID do restaurante seja enviado.
            if (!formData.get('restaurant') && currentUser && currentUser.role !== 'admin') {
                formData.append('restaurant', currentUser._id);
            }

            const token = localStorage.getItem('pedeai_token');
            const btn = e.target.querySelector('button');
            const oldText = btn.innerText;
            
            btn.disabled = true;
            btn.innerText = "Salvando...";

            try {
                // NOTA: Ao usar FormData, N√ÉO definimos 'Content-Type': 'application/json'.
                // O navegador define automaticamente como multipart/form-data com o boundary correto.
                const res = await fetch(`${API}/products`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }, 
                    body: formData 
                });
                
                const json = await res.json();
                
                if(json.success) { 
                    alert('‚úÖ Produto adicionado com sucesso!'); 
                    e.target.reset(); 
                    // Reseta visual da imagem para o padr√£o
                    document.querySelector('input[value="link"]').checked = true;
                    toggleImageInput();
                } else { 
                    alert('Erro: ' + json.message); // Ex: erro de valida√ß√£o ou upload
                }
            } catch(err) { 
                console.error(err);
                alert('Erro de conex√£o com o servidor'); 
            } finally {
                btn.disabled = false;
                btn.innerText = oldText;
            }
        });

        // --- L√ìGICA DE PREVIEW DE IMAGEM ---
    const fileInput = document.getElementById('input-file');
    const previewContainer = document.getElementById('preview-container');
    const previewImage = document.getElementById('image-preview');
    const uploadLabel = document.querySelector('.file-upload-label');

    // Quando o usu√°rio seleciona um arquivo
    fileInput.addEventListener('change', function() {
        const file = this.files[0];

        if (file) {
            // Cria um leitor de arquivos do navegador
            const reader = new FileReader();

            // Quando terminar de ler o arquivo...
            reader.addEventListener("load", function() {
                // Mostra o resultado (base64) na imagem de preview
                previewImage.src = this.result;
                previewContainer.style.display = 'block';
                uploadLabel.style.display = 'none'; // Esconde a √°rea de upload
            });

            // L√™ o arquivo como uma URL de dados
            reader.readAsDataURL(file);
        }
    });

    // Fun√ß√£o para limpar a sele√ß√£o (se o usu√°rio desistir)
    function clearFileInput() {
        fileInput.value = ''; // Limpa o input
        previewImage.src = ''; // Limpa o preview
        previewContainer.style.display = 'none'; // Esconde preview
        uploadLabel.style.display = 'flex'; // Mostra √°rea de upload de volta
    }

    // Atualize a fun√ß√£o toggleImageInput existente para resetar o preview ao trocar de aba
    const originalToggle = toggleImageInput;
    toggleImageInput = function() {
        originalToggle();
        // Se mudou para "Link", limpa o preview do arquivo
        if (document.querySelector('input[name="imgType"]:checked').value === 'link') {
            clearFileInput();
        }
    }
    </script>
</body>
</html>