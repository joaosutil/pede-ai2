<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Configurar Loja - Admin</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="css/styles.css" />
    <script src="js/auth-guard.js"></script>
    <style>
      /* (Mantenha seus estilos CSS aqui...) */
      .form-section {
        background: white;
        padding: 25px;
        border-radius: 12px;
        border: 1px solid #e5e7eb;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
        margin-bottom: 20px;
      }
      .section-title {
        font-size: 1.1rem;
        font-weight: 700;
        color: #374151;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid #eee;
      }
      .grid-2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }
      .preview-img {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        object-fit: cover;
        border: 3px solid #eee;
        margin-top: 10px;
        display: none;
      }
      #admin-restaurant-select {
        display: none;
        padding: 8px;
        border-radius: 6px;
        border: 1px solid #ccc;
        margin-left: 10px;
      }
    </style>
  </head>
  <body>
    <div class="admin-wrapper">
      <aside class="admin-sidebar">
        <div class="sidebar-logo">
          PedeAi<span style="color: var(--color-primary)">.</span>
        </div>
        <nav class="sidebar-menu">
          <a href="admin.html" class="sidebar-link"
            ><span>üè¢</span> Restaurantes</a
          >
          <a href="admin-products.html" class="sidebar-link"
            ><span>üçî</span> Produtos</a
          >
          <a href="admin-orders.html" class="sidebar-link"
            ><span>üîî</span> Pedidos</a
          >
          <a href="admin-finance.html" class="sidebar-link"
            ><span>üí∞</span> Financeiro</a
          >
          <a href="admin-store.html" class="sidebar-link active"
            ><span>‚öôÔ∏è</span> Minha Loja</a
          >
          <div style="margin-top: auto">
            <a href="/" class="sidebar-link" target="_blank"
              ><span>üîó</span> Ver Loja</a
            >
            <a
              href="#"
              onclick="logout()"
              class="sidebar-link"
              style="color: var(--color-danger)"
              ><span>üö™</span> Sair</a
            >
          </div>
        </nav>
      </aside>

      <main class="admin-content">
        <header
          class="page-header"
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
          "
        >
          <div>
            <h1 class="page-title">Configura√ß√µes da Loja</h1>
            <div style="font-size: 0.9rem; color: #666">
              Gerencie local, taxas e hor√°rios
            </div>
          </div>
          <select
            id="admin-restaurant-select"
            onchange="loadStoreData(this.value)"
          >
            <option value="">Selecione...</option>
          </select>
        </header>

        <form id="edit-form">
          <input type="hidden" id="restaurant-id" />

          <div class="form-section">
            <div class="section-title">üè¢ Dados Principais</div>
            <div class="grid-2">
              <div class="form-group">
                <label class="form-label">Nome da Loja</label>
                <input
                  type="text"
                  id="name"
                  name="name"
                  class="form-input"
                  required
                />
              </div>
              <div class="form-group">
                <label class="form-label">Categoria</label>
                <select id="category" name="category" class="form-input">
                  <option value="Hamburgueria">Hamburgueria</option>
                  <option value="Pizzaria">Pizzaria</option>
                  <option value="Brasileira">Brasileira</option>
                  <option value="Japonesa">Japonesa</option>
                  <option value="Doces">Doces</option>
                  <option value="Bebidas">Bebidas</option>
                  <option value="Outros">Outros</option>
                </select>
              </div>
            </div>

            <div class="grid-2" style="margin-top: 15px">
              <div class="form-group">
                <label class="form-label">Estado (UF)</label>
                <select
                  id="addressState"
                  name="addressState"
                  class="form-input"
                  onchange="loadCities(this.value)"
                >
                  <option value="">Carregando...</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">Cidade</label>
                <select id="addressCity" name="addressCity" class="form-input">
                  <option value="">Selecione o Estado primeiro</option>
                </select>
              </div>
            </div>

            <div class="form-group" style="margin-top: 15px">
              <label class="form-label">Logotipo</label>
              <div style="display: flex; gap: 15px; margin-bottom: 10px">
                <label
                  ><input
                    type="radio"
                    name="imgType"
                    value="keep"
                    checked
                    onclick="toggleImageInput()"
                  />
                  Manter</label
                >
                <label
                  ><input
                    type="radio"
                    name="imgType"
                    value="url"
                    onclick="toggleImageInput()"
                  />
                  Link</label
                >
                <label
                  ><input
                    type="radio"
                    name="imgType"
                    value="file"
                    onclick="toggleImageInput()"
                  />
                  Arquivo</label
                >
              </div>
              <div id="url-input-group" style="display: none">
                <input
                  type="url"
                  name="image"
                  class="form-input"
                  placeholder="URL da imagem"
                />
              </div>
              <div id="file-input-group" style="display: none">
                <input
                  type="file"
                  name="imageFile"
                  id="input-file"
                  class="form-input"
                  accept="image/*"
                />
              </div>
              <img id="current-image" class="preview-img" />
            </div>
          </div>

          <div class="form-section">
            <div class="section-title">üõµ Taxas de Entrega</div>
            <div class="grid-2">
              <div class="form-group">
                <label class="form-label">Tempo M√©dio</label>
                <input
                  type="text"
                  id="deliveryTime"
                  name="deliveryTime"
                  class="form-input"
                  placeholder="Ex: 30-40 min"
                />
              </div>
              <div class="form-group">
                <label class="form-label">Taxa Padr√£o (Fallback)</label>
                <input
                  type="number"
                  id="deliveryFee"
                  name="deliveryFee"
                  class="form-input"
                  step="0.01"
                />
              </div>
            </div>

            <div
              style="
                background: #f8f9fa;
                padding: 15px;
                border-radius: 8px;
                margin-top: 15px;
                border: 1px solid #ddd;
              "
            >
              <div
                style="
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                  margin-bottom: 10px;
                "
              >
                <h4 style="color: #374151">üìç Bairros e Taxas</h4>
                <button
                  type="button"
                  onclick="autoFillNeighborhoods()"
                  style="
                    background: #6366f1;
                    color: white;
                    border: none;
                    padding: 5px 10px;
                    border-radius: 4px;
                    cursor: pointer;
                    font-size: 0.8rem;
                  "
                >
                  ‚ö° Importar Bairros da Cidade
                </button>
              </div>

              <div style="display: flex; gap: 10px; margin-bottom: 10px">
                <input
                  type="text"
                  id="zone-name"
                  class="form-input"
                  placeholder="Bairro"
                  style="flex: 2"
                />
                <input
                  type="number"
                  id="zone-price"
                  class="form-input"
                  placeholder="R$"
                  style="flex: 1"
                />
                <button
                  type="button"
                  onclick="addZone()"
                  style="
                    background: var(--color-primary);
                    color: white;
                    border: none;
                    padding: 0 15px;
                    border-radius: 6px;
                  "
                >
                  +
                </button>
              </div>
              <div
                id="zones-list"
                style="display: flex; flex-wrap: wrap; gap: 8px"
              ></div>
            </div>

            <div class="grid-2" style="margin-top: 20px">
              <div class="form-group">
                <label class="form-label">Abre √†s</label
                ><input
                  type="time"
                  id="opensAt"
                  name="opensAt"
                  class="form-input"
                />
              </div>
              <div class="form-group">
                <label class="form-label">Fecha √†s</label
                ><input
                  type="time"
                  id="closesAt"
                  name="closesAt"
                  class="form-input"
                />
              </div>
            </div>
          </div>

          <div class="form-section">
            <div class="section-title">üì± WhatsApp</div>
            <div class="form-group">
              <label class="form-label">N√∫mero (com 55)</label>
              <input type="text" id="phone" name="phone" class="form-input" />
            </div>
            <div class="form-group" style="margin-top: 10px">
              <label class="form-label">Mensagem</label>
              <textarea
                id="whatsappTemplate"
                name="whatsappTemplate"
                class="form-input"
                rows="3"
              ></textarea>
            </div>
          </div>

          <div style="text-align: right; margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee;">
            <button
              type="submit"
              style="
                background-color: #10b981; /* Verde Emerald Fixo */
                color: white;
                padding: 14px 30px;
                border: none;
                border-radius: 8px;
                font-weight: 700;
                font-size: 1rem;
                cursor: pointer;
                box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.4);
                transition: transform 0.2s;
              "
              onmouseover="this.style.transform='scale(1.02)'"
              onmouseout="this.style.transform='scale(1)'"
            >
              üíæ Salvar Altera√ß√µes
            </button>
          </div>
        </form>
        <div style="margin-top: 50px; border: 1px solid #fecaca; background: #fef2f2; border-radius: 12px; padding: 25px;">
            <h3 style="color: #991b1b; margin-top:0; font-size: 1.1rem;">Zona de Perigo ‚ò†Ô∏è</h3>
            <p style="color: #7f1d1d; font-size: 0.9rem; margin-bottom: 20px;">
                Deseja excluir esta loja permanentemente? Isso apagar√° o card√°pio, hist√≥rico de pedidos e configura√ß√µes. 
                <strong>Esta a√ß√£o n√£o pode ser desfeita.</strong>
            </p>
            <button type="button" onclick="deleteStore()" style="
                background: #dc2626; 
                color: white; 
                border: none; 
                padding: 12px 20px; 
                border-radius: 8px; 
                cursor: pointer; 
                font-weight: bold;
                display: flex;
                align-items: center;
                gap: 8px;">
                üóëÔ∏è Excluir Loja Permanentemente
            </button>
      </main>
    </div>

    <script>
      const API = "http://localhost:3000/api";
      let currentZones = [];

      // --- LISTA DE BAIRROS (JOINVILLE EXEMPLO) ---
      // Voc√™ pode adicionar mais cidades aqui manualmente se quiser
      const CITY_DATA = {
        Joinville: [
          "Centro",
          "Am√©rica",
          "Anita Garibaldi",
          "Atiradores",
          "Aventureiro",
          "Boa Vista",
          "Bom Retiro",
          "Bucarein",
          "Costa e Silva",
          "F√°tima",
          "Floresta",
          "Gl√≥ria",
          "Guanabara",
          "Iriri√∫",
          "Itaum",
          "Jardim Para√≠so",
          "Jardim Sofia",
          "Jarivatuba",
          "Jocum",
          "Morro do Meio",
          "Nova Bras√≠lia",
          "Paranaguamirim",
          "Petr√≥polis",
          "Pirabeiraba",
          "Profipo",
          "Sagua√ßu",
          "Santa Catarina",
          "Santo Ant√¥nio",
          "S√£o Marcos",
          "Vila Nova",
        ],
      };

      (async () => {
        const token = localStorage.getItem("pedeai_token");
        if (!token) return (window.location.href = "login.html");

        // 1. Carrega Estados do IBGE
        await loadIBGEStates();

        // 2. Auth e Carga Inicial
        try {
          const resUser = await fetch(`${API}/auth/me`, {
            headers: { Authorization: `Bearer ${token}` },
          });
          const jsonUser = await resUser.json();
          if (jsonUser.data.role === "admin") {
            document.getElementById("admin-restaurant-select").style.display =
              "block";
            loadAdminList(token);
          } else {
            loadStoreData(jsonUser.data._id);
          }
        } catch (e) {
          console.error(e);
        }
      })();

      // --- API IBGE ---
      async function loadIBGEStates() {
        try {
          const res = await fetch(
            "https://servicodados.ibge.gov.br/api/v1/localidades/estados?orderBy=nome"
          );
          const states = await res.json();
          const select = document.getElementById("addressState");
          select.innerHTML = '<option value="">Selecione...</option>';
          states.forEach((uf) => {
            const opt = document.createElement("option");
            opt.value = uf.sigla;
            opt.textContent = uf.sigla; // Ex: SC
            select.appendChild(opt);
          });
        } catch (e) {
          console.error("Erro IBGE UF", e);
        }
      }

      async function loadCities(uf) {
        if (!uf) return;
        try {
          const res = await fetch(
            `https://servicodados.ibge.gov.br/api/v1/localidades/estados/${uf}/municipios`
          );
          const cities = await res.json();
          const select = document.getElementById("addressCity");
          select.innerHTML = '<option value="">Selecione...</option>';
          cities.forEach((c) => {
            const opt = document.createElement("option");
            opt.value = c.nome;
            opt.textContent = c.nome;
            select.appendChild(opt);
          });
        } catch (e) {
          console.error("Erro IBGE Cidades", e);
        }
      }

      // --- PREENCHIMENTO AUTOM√ÅTICO DE BAIRROS ---
      function autoFillNeighborhoods() {
        const city = document.getElementById("addressCity").value;
        if (!city) return alert("Selecione uma cidade primeiro.");

        const bairros = CITY_DATA[city];
        if (!bairros)
          return alert(
            `Ainda n√£o temos a lista autom√°tica para ${city}. Adicione manualmente.`
          );

        if (
          !confirm(
            `Deseja adicionar todos os ${bairros.length} bairros de ${city}? Isso pode duplicar se j√° houver.`
          )
        )
          return;

        bairros.forEach((b) => {
          // Adiciona com pre√ßo 0 por padr√£o
          currentZones.push({ name: b, price: 0 });
        });
        renderZones();
        alert("Bairros importados! Agora defina os pre√ßos de cada um.");
      }

      // ... (Fun√ß√µes padr√£o: loadStoreData, fillForm, addZone, renderZones, submit, etc) ...
      // MANTENHA A L√ìGICA DE CARREGAMENTO QUE J√Å TINHAMOS, MAS ATUALIZE O fillForm:

      async function loadAdminList(token) {
        const res = await fetch(`${API}/restaurants`, {
          headers: { Authorization: `Bearer ${token}` },
        });
        const json = await res.json();
        if (json.success) {
          const sel = document.getElementById("admin-restaurant-select");
          json.data.forEach((r) => {
            const opt = document.createElement("option");
            opt.value = r._id;
            opt.textContent = r.name;
            sel.appendChild(opt);
          });
        }
      }

      async function loadStoreData(id) {
        if (!id) return;
        const token = localStorage.getItem("pedeai_token");
        const res = await fetch(`${API}/restaurants/${id}`, {
          headers: { Authorization: `Bearer ${token}` },
        });
        const json = await res.json();
        if (json.success) fillForm(json.data);
      }

      async function fillForm(data) {
        document.getElementById("restaurant-id").value = data._id;
        document.getElementById("name").value = data.name;
        document.getElementById("category").value = data.category;

        // Preenche Estado e Cidade
        if (data.addressState) {
          document.getElementById("addressState").value = data.addressState;
          await loadCities(data.addressState); // Espera carregar cidades
          document.getElementById("addressCity").value = data.addressCity;
        }

        document.getElementById("deliveryTime").value = data.deliveryTime || "";
        document.getElementById("deliveryFee").value = data.deliveryFee || "";
        document.getElementById("opensAt").value = data.opensAt;
        document.getElementById("closesAt").value = data.closesAt;
        document.getElementById("phone").value = data.phone;
        document.getElementById("whatsappTemplate").value =
          data.whatsappTemplate;

        if (data.image) {
          document.getElementById("current-image").src = data.image;
          document.getElementById("current-image").style.display = "block";
        }

        currentZones = data.deliveryZones || [];
        renderZones();
      }

      function addZone() {
        const name = document.getElementById("zone-name").value;
        const price = parseFloat(document.getElementById("zone-price").value);
        if (name && !isNaN(price)) {
          currentZones.push({ name, price });
          renderZones();
          document.getElementById("zone-name").value = "";
        }
      }

      function removeZone(i) {
        currentZones.splice(i, 1);
        renderZones();
      }

      function renderZones() {
        const list = document.getElementById("zones-list");
        list.innerHTML = currentZones
          .map(
            (z, i) => `
                <div style="background:#eee; padding:5px 10px; border-radius:15px; font-size:0.85rem; display:flex; align-items:center; gap:5px;">
                    <b>${z.name}</b>: R$ <input type="number" value="${z.price}" style="width:50px; border:none; background:transparent; font-weight:bold;" onchange="updateZonePrice(${i}, this.value)">
                    <span onclick="removeZone(${i})" style="color:red; cursor:pointer; font-weight:bold;">&times;</span>
                </div>
            `
          )
          .join("");
      }

      function updateZonePrice(index, newVal) {
        currentZones[index].price = parseFloat(newVal);
      }

      function toggleImageInput() {
        const type = document.querySelector(
          'input[name="imgType"]:checked'
        ).value;
        document.getElementById("file-input-group").style.display =
          type === "file" ? "block" : "none";
        document.getElementById("url-input-group").style.display =
          type === "url" ? "block" : "none";
      }

      document
        .getElementById("edit-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const id = document.getElementById("restaurant-id").value;
          const token = localStorage.getItem("pedeai_token");

          // Mesma l√≥gica de envio de antes (JSON ou FormData)
          // Vou simplificar aqui para JSON pois √© mais seguro
          const data = {};
          new FormData(e.target).forEach((v, k) => {
            if (k !== "imageFile") data[k] = v;
          });
          data.deliveryZones = currentZones;

          // Remove imagem se for 'keep'
          if (
            document.querySelector('input[name="imgType"]:checked').value ===
            "keep"
          )
            delete data.image;

          // Se for arquivo... (implemente a l√≥gica FormData se precisar, ou use JSON se for s√≥ URL/Texto)
          // Para garantir, vamos usar JSON aqui
          try {
            const res = await fetch(`${API}/restaurants/${id}`, {
              method: "PUT",
              headers: {
                Authorization: `Bearer ${token}`,
                "Content-Type": "application/json",
              },
              body: JSON.stringify(data),
            });
            const json = await res.json();
            if (json.success) alert("‚úÖ Salvo com sucesso!");
            else alert("Erro: " + json.error);
          } catch (e) {
            console.error(e);
          }
        });

      function logout() {
        localStorage.removeItem("pedeai_token");
        window.location.href = "login.html";
      }


      // --- FUN√á√ÉO PARA DELETAR LOJA ---
      async function deleteStore() {
          const id = document.getElementById("restaurant-id").value;
          const name = document.getElementById("name").value;

          if (!id) return alert("Nenhuma loja carregada para excluir.");

          // 1. Confirma√ß√£o B√°sica
          if (!confirm("‚ö†Ô∏è ATEN√á√ÉO CR√çTICA\n\nVoc√™ tem certeza que deseja EXCLUIR PERMANENTEMENTE esta loja?")) {
              return;
          }

          // 2. Confirma√ß√£o de Seguran√ßa (Digitar o nome)
          const confirmation = prompt(`Para confirmar, digite exatamente o nome da loja:\n"${name}"`);
          
          if (confirmation !== name) {
              return alert("Nome incorreto. A√ß√£o cancelada para sua seguran√ßa.");
          }

          const token = localStorage.getItem("pedeai_token");

          try {
              const res = await fetch(`${API}/restaurants/${id}`, {
                  method: 'DELETE',
                  headers: { 
                      'Authorization': `Bearer ${token}`,
                      'Content-Type': 'application/json'
                  }
              });

              // Se o servidor retornar HTML de erro em vez de JSON, pegamos o erro aqui
              if (!res.ok) {
                  const text = await res.text();
                  throw new Error(text || res.statusText);
              }

              const json = await res.json();

              if (json.success) {
                  alert("Loja exclu√≠da com sucesso! üëã");
                  
                  // Se for admin gerenciando, recarrega a p√°gina. Se for dono, faz logout.
                  const resUser = await fetch(`${API}/auth/me`, { headers: { Authorization: `Bearer ${token}` } });
                  const userJson = await resUser.json();

                  if (userJson.data.role === 'admin') {
                      window.location.reload(); // Admin continua no painel
                  } else {
                      localStorage.removeItem("pedeai_token");
                      window.location.href = 'index.html'; // Dono sai do sistema
                  }
              } else {
                  alert("Erro ao excluir: " + (json.error || json.message));
              }

          } catch (e) {
              console.error(e);
              alert("Erro ao processar exclus√£o. Verifique o console ou se voc√™ tem permiss√£o.");
          }
      }
    </script>
  </body>
</html>
